<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Budget Tracker</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5;
        }

        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        .btn-primary {
            background-color: #4f46e5;
            color: white;
            transition: background-color 0.3s ease;
        }

        .btn-primary:hover {
            background-color: #4338ca;
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.3s ease-out;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* Calendar Styles */
        .calendar-day {
            transition: all 0.2s ease;
        }

        .calendar-day.has-transactions {
            background-color: #e0e7ff;
            font-weight: 600;
            color: #4338ca;
        }

        .calendar-day.selected {
            background-color: #4f46e5 !important;
            color: white !important;
            transform: scale(1.1);
        }

        @media (max-width: 640px) {
            /* header .container {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            } */

            header h1 {
                font-size: 1.5rem;
                margin-bottom: 0.5rem;
            }

            #add-transaction-btn {
                width: 100%;
                justify-content: center;
            }

            #auth-container {
                justify-content: center;
                width: 100%;
            }

            #logout-btn {
                margin-left: 0;
            }

            .hide-scrollbar {
                overflow: auto;
                scrollbar-width: none;
                /* Firefox */
                -ms-overflow-style: none;
                /* Internet Explorer 10+ */
            }

            .hide-scrollbar::-webkit-scrollbar {
                display: none;
                /* Chrome, Safari and Opera */
            }
        }

        /* For most modern browsers */
        .hide-scrollbar {
            overflow: auto;
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* Internet Explorer 10+ */
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
            /* Chrome, Safari and Opera */
        }
    </style>
</head>

<body class="hide-scrollbar min-h-screen">

    <!-- Login Overlay -->
    <div id="login-overlay"
        class="fixed inset-0 bg-gray-100 flex flex-col items-center justify-center z-50 p-4 text-center">
        <i class="fas fa-wallet text-5xl text-indigo-600 mb-4"></i>
        <h1 class="text-3xl font-bold text-gray-800">Welcome to Your Budget Tracker</h1>
        <p class="text-gray-600 mt-2 max-w-md">Securely track your income and expenses to achieve your financial goals.
            Your data is private and saved automatically.</p>
        <button id="login-btn"
            class="mt-8 btn-primary font-bold py-3 px-8 rounded-lg text-lg transform hover:scale-105 transition-transform flex items-center space-x-3">
            <i class="fab fa-google"></i>
            <span>Sign In with Google</span>
        </button>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay"
        class="hidden fixed inset-0 bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center z-50 p-4">
        <div class="w-16 h-16 border-4 border-t-transparent border-indigo-600 rounded-full animate-spin"></div>
        <p class="mt-4 text-lg font-semibold text-gray-700">Connecting...</p>
    </div>

    <!-- Main Application Wrapper -->
    <div id="app-wrapper" class="hidden">
        <header class="bg-white shadow-md sticky top-0 z-30">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-wallet text-indigo-600 mr-3"></i>
                    <span>Dashboard</span>
                </h1>
                <div class="flex items-center space-x-4">
                    <button id="add-transaction-btn"
                        class="btn-primary px-4 py-2 rounded-lg font-semibold text-sm flex items-center space-x-2">
                        <i class="fas fa-plus"></i>
                        <span>Add TN</span>
                    </button>
                    <div id="auth-container" class="hidden items-center">
                        <span id="user-id-display" class="font-medium text-gray-700 hidden sm:block"></span>
                        <button id="logout-btn" class="ml-4 text-gray-500 hover:text-indigo-600" title="Logout">
                            <i class="fas fa-sign-out-alt fa-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Dashboard Cards -->
            <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Cards for Balance, Income, Expense -->
                <div class="card p-6 flex items-center space-x-4">
                    <div class="bg-green-100 text-green-600 p-4 rounded-full"><i
                            class="fa-solid fa-indian-rupee-sign fa-2x"></i></div>
                    <div>
                        <p class="text-gray-500 text-sm">Current Balance</p>
                        <h2 id="current-balance" class="text-3xl font-bold text-gray-800"></h2>
                    </div>
                </div>
                <div class="card p-6 flex items-center space-x-4">
                    <div class="bg-blue-100 text-blue-600 p-4 rounded-full"><i class="fas fa-arrow-up fa-2x"></i></div>
                    <div>
                        <p class="text-gray-500 text-sm">Total Income</p>
                        <h2 id="total-income" class="text-3xl font-bold text-gray-800"></h2>
                    </div>
                </div>
                <div class="card p-6 flex items-center space-x-4">
                    <div class="bg-red-100 text-red-600 p-4 rounded-full"><i class="fas fa-arrow-down fa-2x"></i></div>
                    <div>
                        <p class="text-gray-500 text-sm">Total Expense</p>
                        <h2 id="total-expense" class="text-3xl font-bold text-gray-800"></h2>
                    </div>
                </div>
            </section>

            <!-- Main Content Area -->
            <section class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Column: Charts & Goals -->
                <div class="lg:col-span-2 space-y-8">
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Income vs Expense Trend</h3><canvas
                            id="trend-chart"></canvas>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Expense by Category</h3>
                        <div class="max-h-80 mx-auto flex justify-center"><canvas id="category-chart"></canvas></div>
                    </div>

                    <!-- Financial Goals -->
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-700">Financial Goals</h3>
                            <button id="add-goal-btn"
                                class="bg-indigo-100 text-indigo-600 px-4 py-2 rounded-lg font-semibold text-sm flex items-center space-x-2 hover:bg-indigo-200">
                                <i class="fas fa-bullseye"></i><span>Set a Goal</span>
                            </button>
                        </div>
                        <div id="goals-list" class="space-y-4"></div>
                        <div id="goals-empty-state" class="hidden text-center py-6">
                            <p class="text-gray-500">No goals set yet. Click "Set a Goal" to start!</p>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Calendar & Transactions -->
                <div class="space-y-8">
                    <!-- Calendar -->
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-4">
                            <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-100"><i
                                    class="fas fa-chevron-left"></i></button>
                            <h3 id="calendar-month-year" class="text-lg font-semibold text-gray-700"></h3>
                            <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-100"><i
                                    class="fas fa-chevron-right"></i></button>
                        </div>
                        <div id="calendar-grid" class="grid grid-cols-7 gap-2 text-center"></div>
                    </div>

                    <!-- Transactions -->
                    <div class="card p-6 flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-700">Transactions</h3>
                            <button id="show-all-btn"
                                class="hidden text-indigo-600 text-sm font-semibold hover:underline">Show All</button>
                        </div>
                        <div id="transaction-list"
                            class="custom-scrollbar flex-grow space-y-3 overflow-y-auto pr-2 max-h-[500px]"></div>
                        <div id="transactions-empty-state" class="hidden text-center py-10"><i
                                class="fas fa-file-invoice-dollar text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">No transactions recorded.</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <!-- Add/Edit Transaction Modal -->
    <div id="transaction-modal" class="modal-overlay fixed inset-0 hidden items-center justify-center z-40 p-4">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-xl font-bold text-gray-800">Add Transaction</h2>
                <button class="close-modal-btn text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <form id="transaction-form"><input type="hidden" id="transaction-id">
                <div class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                        <div class="grid grid-cols-2 gap-2"><button type="button" id="type-income"
                                class="transaction-type-btn border py-2 rounded-lg"
                                data-type="income">Income</button><button type="button" id="type-expense"
                                class="transaction-type-btn border py-2 rounded-lg" data-type="expense">Expense</button>
                        </div>
                    </div>
                    <div><label for="description"
                            class="block text-sm font-medium text-gray-700">Description</label><input type="text"
                            id="description"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                            required></div>
                    <div><label for="amount" class="block text-sm font-medium text-gray-700">Amount</label>
                        <div class="relative">
                            <div id="currency-symbol-modal"
                                class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><span
                                    class="text-gray-500 sm:text-sm"></span></div><input type="number" id="amount"
                                step="0.01" min="0"
                                class="pl-7 mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                                required>
                        </div>
                    </div>
                    <div><label for="category" class="block text-sm font-medium text-gray-700">Category</label><select
                            id="category"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                            required></select></div>
                    <div><label for="date" class="block text-sm font-medium text-gray-700">Date</label><input
                            type="date" id="date"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                            required></div>
                </div>
                <div class="mt-6 flex justify-end space-x-3"><button type="button"
                        class="cancel-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300">Cancel</button><button
                        type="submit" class="btn-primary px-4 py-2 rounded-lg font-semibold">Save Transaction</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Add/Edit Goal Modal -->
    <div id="goal-modal" class="modal-overlay fixed inset-0 hidden items-center justify-center z-40 p-4">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 id="goal-modal-title" class="text-xl font-bold text-gray-800">Set a Goal</h2><button
                    class="close-modal-btn text-gray-400 hover:text-gray-600"><i
                        class="fas fa-times fa-lg"></i></button>
            </div>
            <form id="goal-form"><input type="hidden" id="goal-id">
                <div class="space-y-4">
                    <div><label for="goal-name" class="block text-sm font-medium text-gray-700">Goal Name</label><input
                            type="text" id="goal-name" placeholder="e.g., Vacation Fund"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                            required></div>
                    <div><label for="goal-target" class="block text-sm font-medium text-gray-700">Target
                            Amount</label><input type="number" id="goal-target" min="0" step="0.01"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                            required></div>
                    <div><label for="goal-current" class="block text-sm font-medium text-gray-700">Current Amount
                            Saved</label><input type="number" id="goal-current" min="0" step="0.01"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                            required></div>
                </div>
                <div class="mt-6 flex justify-end space-x-3"><button type="button"
                        class="cancel-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300">Cancel</button><button
                        type="submit" class="btn-primary px-4 py-2 rounded-lg font-semibold">Save Goal</button></div>
            </form>
        </div>
    </div>

    <!-- Footer Modals -->
    <div id="about-modal" class="modal-overlay fixed inset-0 hidden items-center justify-center z-40 p-4">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 overflow-y-auto"
            style="max-height: 90vh;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">About Budget Tracker</h2><button
                    class="close-modal-btn text-gray-400 hover:text-gray-600"><i
                        class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="prose max-w-none text-gray-600">
                <p>Welcome to Professional Budget Tracker, your personal financial companion designed to bring clarity
                    and control to your financial life. Our mission is to provide a simple, secure, and powerful tool
                    that helps you manage your income, track your expenses, and achieve your financial goals.</p>
                <p>Built with modern technology, this application ensures your data is private and accessible only to
                    you. We leverage Google's secure Firebase platform for authentication and data storage, meaning your
                    financial information is protected by industry-leading security standards. Every user's data is
                    isolated, ensuring complete privacy.</p>
                <p>We hope this tool empowers you to make informed financial decisions and helps you on your journey to
                    financial freedom.</p>
            </div>
        </div>
    </div>
    <div id="privacy-modal" class="modal-overlay fixed inset-0 hidden items-center justify-center z-40 p-4">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 overflow-y-auto"
            style="max-height: 90vh;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Privacy Policy</h2><button
                    class="close-modal-btn text-gray-400 hover:text-gray-600"><i
                        class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="prose max-w-none text-gray-600 space-y-4">
                <p>Your privacy is our top priority. This policy outlines how we handle your information.</p>
                <div>
                    <h3 class="font-semibold text-gray-700">Information We Collect</h3>
                    <ul class="list-disc list-inside">
                        <li><strong>Personal Information:</strong> When you sign in with Google, we receive your name,
                            email address, and profile picture as provided by Google. We use this solely to identify you
                            within the app.</li>
                        <li><strong>Financial Data:</strong> All transaction and goal data you enter is stored securely
                            in our database. We do not view, analyze, or share this personal financial data.</li>
                        <li><strong>Usage Data:</strong> We use Google Analytics to collect anonymous data about how you
                            interact with our application (e.g., which features are used most). This helps us improve
                            the service and does not include any personal or financial information.</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-700">Data Storage and Security</h3>
                    <p>Your data is stored on Google's Firebase Firestore, a secure, cloud-based database. We use
                        Firebase's security rules to ensure that only you, the authenticated user, can access your own
                        data. Your financial information is not accessible by our team or any third parties.</p>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-700">Your Rights</h3>
                    <p>You have full control over your data. You can edit or delete any transaction or goal at any time.
                        Deleting your Google account's access to this app will prevent future sign-ins, and your data
                        will remain securely stored under your unique user ID unless you delete it beforehand.</p>
                </div>
            </div>
        </div>
    </div>
    <div id="contact-modal" class="modal-overlay fixed inset-0 hidden items-center justify-center z-40 p-4">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md p-6 text-center">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Contact Us</h2>
                <button class="close-modal-btn text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <div class="space-y-4 gap-2">
                <p class="text-gray-600">We value your feedback and are here to help you with any questions or issues
                    you may have.</p>
                <p class="text-gray-600">For support, feedback, or inquiries, please email us at:</p>
                <a href="mailto:rahul.sharma.alx@gmail.com"
                    class="text-indigo-600 font-semibold text-lg hover:underline">rahul.sharma.alx@gmail.com</a>
                <a href="https://github.com/rahul-sharma-alx" target="_blank"
                    class="text-gray-400 hover:text-sky-400 transition">
                    <i class="fab fa-github text-xl"></i>
                </a>
            </div>
        </div>
    </div>

    <footer class="bg-white mt-12 py-8 border-t">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center text-gray-500">
            <div class="flex justify-center space-x-6 mb-4">
                <button id="about-btn" class="hover:text-indigo-600 transition-colors">About</button>
                <button id="privacy-btn" class="hover:text-indigo-600 transition-colors">Privacy Policy</button>
                <button id="contact-btn" class="hover:text-indigo-600 transition-colors">Contact</button>
            </div>
            <p>&copy; 2025 Professional Budget Tracker. All Rights Reserved.</p>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDQLmHTC638TqO3jF4pbTPalUqz5k91Bkw",
            authDomain: "budget-tracker-42c28.firebaseapp.com",
            projectId: "budget-tracker-42c28",
            storageBucket: "budget-tracker-42c28.firebasestorage.app",
            messagingSenderId: "679151709021",
            appId: "1:679151709021:web:35cbce2ffcd9f1a97316b4",
            measurementId: "G-T9P99HWDM9"
        };

        // --- Global State ---
        let transactions = [], goals = [];
        let trendChart, categoryChart;
        let currentUserId = null;
        let transactionType = 'expense', editingTransactionId = null, editingGoalId = null;
        let currentDate = new Date();
        let selectedDate = null;
        let currencyFormatter;

        const incomeCategories = ['Salary', 'Bonus', 'Gift', 'Investment', 'Other'];
        const expenseCategories = ['Food', 'Transport', 'Bills', 'Entertainment', 'Shopping', 'Health', 'Other'];

        const dom = {
            loginOverlay: document.getElementById('login-overlay'),
            loginBtn: document.getElementById('login-btn'),
            loadingOverlay: document.getElementById('loading-overlay'),
            appWrapper: document.getElementById('app-wrapper'),
            authContainer: document.getElementById('auth-container'),
            logoutBtn: document.getElementById('logout-btn'),
            currentBalance: document.getElementById('current-balance'),
            totalIncome: document.getElementById('total-income'),
            totalExpense: document.getElementById('total-expense'),
            transactionList: document.getElementById('transaction-list'),
            transactionsEmptyState: document.getElementById('transactions-empty-state'),
            addTransactionBtn: document.getElementById('add-transaction-btn'),
            transactionModal: document.getElementById('transaction-modal'),
            modalTitle: document.getElementById('modal-title'),
            transactionForm: document.getElementById('transaction-form'),
            typeIncomeBtn: document.getElementById('type-income'),
            typeExpenseBtn: document.getElementById('type-expense'),
            descriptionInput: document.getElementById('description'),
            amountInput: document.getElementById('amount'),
            categorySelect: document.getElementById('category'),
            dateInput: document.getElementById('date'),
            userIdDisplay: document.getElementById('user-id-display'),
            currencySymbolModal: document.getElementById('currency-symbol-modal').querySelector('span'),
            addGoalBtn: document.getElementById('add-goal-btn'),
            goalModal: document.getElementById('goal-modal'),
            goalModalTitle: document.getElementById('goal-modal-title'),
            goalForm: document.getElementById('goal-form'),
            goalNameInput: document.getElementById('goal-name'),
            goalTargetInput: document.getElementById('goal-target'),
            goalCurrentInput: document.getElementById('goal-current'),
            goalsList: document.getElementById('goals-list'),
            goalsEmptyState: document.getElementById('goals-empty-state'),
            calendarGrid: document.getElementById('calendar-grid'),
            calendarMonthYear: document.getElementById('calendar-month-year'),
            prevMonthBtn: document.getElementById('prev-month-btn'),
            nextMonthBtn: document.getElementById('next-month-btn'),
            showAllBtn: document.getElementById('show-all-btn'),
            // Footer elements
            aboutBtn: document.getElementById('about-btn'),
            privacyBtn: document.getElementById('privacy-btn'),
            contactBtn: document.getElementById('contact-btn'),
            aboutModal: document.getElementById('about-modal'),
            privacyModal: document.getElementById('privacy-modal'),
            contactModal: document.getElementById('contact-modal'),
        };

        // --- App Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);

        // --- General Event Listeners ---
        dom.loginBtn.addEventListener('click', handleLogin);
        dom.logoutBtn.addEventListener('click', handleLogout);
        dom.addTransactionBtn.addEventListener('click', openTransactionModalForAdd);
        dom.transactionForm.addEventListener('submit', handleTransactionFormSubmit);
        dom.typeIncomeBtn.addEventListener('click', () => setTransactionType('income'));
        dom.typeExpenseBtn.addEventListener('click', () => setTransactionType('expense'));
        dom.addGoalBtn.addEventListener('click', openGoalModalForAdd);
        dom.goalForm.addEventListener('submit', handleGoalFormSubmit);
        document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', closeModal));
        document.querySelectorAll('.cancel-btn').forEach(btn => btn.addEventListener('click', closeModal));
        dom.prevMonthBtn.addEventListener('click', () => changeMonth(-1));
        dom.nextMonthBtn.addEventListener('click', () => changeMonth(1));
        dom.showAllBtn.addEventListener('click', showAllTransactions);
        dom.aboutBtn.addEventListener('click', () => openModal('about-modal'));
        dom.privacyBtn.addEventListener('click', () => openModal('privacy-modal'));
        dom.contactBtn.addEventListener('click', () => openModal('contact-modal'));

        // --- Currency Formatting ---
        function setupCurrencyFormatter() {
            const locale = navigator.language || 'en-IN';
            // Find a currency for the locale, default to INR
            let currency = 'INR';
            try {
                // This is a bit of a hack, but it's the most reliable way
                // to get a likely currency for a given locale without an API.
                const parts = new Intl.NumberFormat(locale, { style: 'currency', currency: 'INR' }).formatToParts(1);
                const currencyCodeGuess = parts.find(part => part.type === 'currency')?.value;
                // A more robust check might be needed for some locales
                currency = new Intl.NumberFormat(locale, { style: 'currency', currency: currencyCodeGuess || 'INR' }).resolvedOptions().currency;
            } catch (e) {
                console.warn("Could not determine local currency, defaulting to INR.");
            }

            currencyFormatter = new Intl.NumberFormat(locale, {
                style: 'currency',
                currency: currency,
            });

            // Update the symbol in the modal
            const symbolPart = currencyFormatter.formatToParts(1).find(part => part.type === 'currency');
            dom.currencySymbolModal.textContent = symbolPart ? symbolPart.value : '$';
        }

        function formatCurrency(amount) {
            if (!currencyFormatter) setupCurrencyFormatter();
            return currencyFormatter.format(amount);
        }

        // --- Authentication ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                dom.userIdDisplay.textContent = user.displayName || 'Welcome!';
                dom.authContainer.classList.remove('hidden');
                dom.authContainer.classList.add('flex');
                initAppForUser();
            } else {
                dom.loadingOverlay.classList.add('hidden');
                dom.appWrapper.classList.add('hidden');
                dom.authContainer.classList.add('hidden');
                dom.loginOverlay.classList.remove('hidden');
            }
        });

        async function handleLogin() {
            dom.loginOverlay.classList.add('hidden');
            dom.loadingOverlay.classList.remove('hidden');
            const provider = new GoogleAuthProvider();
            try { await signInWithPopup(auth, provider); } catch (error) {
                console.error("Google sign-in failed:", error);
                dom.loadingOverlay.classList.add('hidden');
                dom.loginOverlay.classList.remove('hidden');
                alert("Authentication Failed. Please try again.");
            }
        }

        async function handleLogout() {
            try { await signOut(auth); transactions = []; goals = []; updateUI(); } catch (error) {
                console.error("Sign out failed:", error);
            }
        }

        // --- App Logic ---
        function initAppForUser() {
            setupCurrencyFormatter();
            initCharts();
            listenForTransactions();
            listenForGoals();
            renderCalendar();
            dom.loginOverlay.classList.add('hidden');
            dom.loadingOverlay.classList.add('hidden');
            dom.appWrapper.classList.remove('hidden');
        }

        function listenForTransactions() {
            if (!currentUserId) return;
            const q = query(collection(db, `users/${currentUserId}/transactions`), orderBy('date', 'desc'));
            onSnapshot(q, (snapshot) => {
                try {
                    transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateUI();
                } catch (error) {
                    console.error("Error updating UI for transactions:", error);
                    // Optionally, display a non-intrusive error message to the user
                }
            });
        }

        function listenForGoals() {
            if (!currentUserId) return;
            const q = query(collection(db, `users/${currentUserId}/goals`), orderBy('name'));
            onSnapshot(q, (snapshot) => {
                goals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderGoals();
            });
        }

        function updateUI() {
            renderTransactions(selectedDate);
            renderCalendar();
            renderGoals();
            updateDashboardCards();
            updateCharts();
        }

        // --- Calendar Logic ---
        function renderCalendar() {
            dom.calendarGrid.innerHTML = '';
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            dom.calendarMonthYear.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const dayHeaders = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            dayHeaders.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = 'font-bold text-gray-500 text-xs';
                dayEl.textContent = day;
                dom.calendarGrid.appendChild(dayEl);
            });

            for (let i = 0; i < firstDay; i++) dom.calendarGrid.appendChild(document.createElement('div'));

            const transactionDates = transactions.map(t => new Date(t.date).toDateString());

            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('button');
                dayEl.className = 'calendar-day p-2 rounded-full text-sm';
                dayEl.textContent = day;
                const dateStr = new Date(year, month, day).toDateString();
                if (transactionDates.includes(dateStr)) {
                    dayEl.classList.add('has-transactions');
                }
                if (selectedDate === dateStr) {
                    dayEl.classList.add('selected');
                }
                dayEl.onclick = () => filterByDate(dateStr);
                dom.calendarGrid.appendChild(dayEl);
            }
        }

        function changeMonth(offset) {
            currentDate.setMonth(currentDate.getMonth() + offset);
            renderCalendar();
        }

        function filterByDate(dateStr) {
            selectedDate = dateStr;
            renderCalendar();
            renderTransactions(dateStr);
            dom.showAllBtn.classList.remove('hidden');
        }

        function showAllTransactions() {
            selectedDate = null;
            renderCalendar();
            renderTransactions();
            dom.showAllBtn.classList.add('hidden');
        }

        // --- Transaction Logic ---
        function renderTransactions(filterDate = null) {
            dom.transactionList.innerHTML = '';
            const filteredTransactions = filterDate
                ? transactions.filter(t => new Date(t.date).toDateString() === filterDate)
                : transactions;

            if (filteredTransactions.length === 0) {
                dom.transactionsEmptyState.classList.remove('hidden');
                return;
            }
            dom.transactionsEmptyState.classList.add('hidden');

            filteredTransactions.forEach(tx => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100';
                const isIncome = tx.type === 'income';
                item.innerHTML = `
                    <div class="flex items-center space-x-4 min-w-0">
                        <div class="flex-shrink-0 p-2 rounded-full ${isIncome ? 'bg-green-100' : 'bg-red-100'}"><i class="fas ${isIncome ? 'fa-arrow-up' : 'fa-arrow-down'} ${isIncome ? 'text-green-600' : 'text-red-600'}"></i></div>
                        <div class="min-w-0"><p class="font-semibold text-gray-800 truncate">${tx.description}</p><p class="text-sm text-gray-500">${tx.category} &bull; ${new Date(tx.date).toLocaleDateString()}</p></div>
                    </div>
                    <div class="flex items-center space-x-3 flex-shrink-0">
                         <p class="font-bold ${isIncome ? 'text-green-600' : 'text-red-600'}">${isIncome ? '+' : '-'}${formatCurrency(tx.amount)}</p>
                         <button class="edit-btn text-gray-400 hover:text-indigo-600" data-id="${tx.id}" data-type="transaction"><i class="fas fa-pencil-alt"></i></button>
                         <button class="delete-btn text-gray-400 hover:text-red-600" data-id="${tx.id}" data-type="transaction"><i class="fas fa-trash-alt"></i></button>
                    </div>`;
                dom.transactionList.appendChild(item);
            });

            document.querySelectorAll('.delete-btn[data-type="transaction"]').forEach(btn => btn.addEventListener('click', (e) => deleteTransaction(e.currentTarget.dataset.id)));
            document.querySelectorAll('.edit-btn[data-type="transaction"]').forEach(btn => btn.addEventListener('click', (e) => openTransactionModalForEdit(e.currentTarget.dataset.id)));
        }

        function updateDashboardCards() {
            const income = transactions.reduce((s, t) => s + (t.type === 'income' ? parseFloat(t.amount) : 0), 0);
            const expense = transactions.reduce((s, t) => s + (t.type === 'expense' ? parseFloat(t.amount) : 0), 0);
            const balance = income - expense;
            dom.totalIncome.textContent = formatCurrency(income);
            dom.totalExpense.textContent = formatCurrency(expense);
            dom.currentBalance.textContent = formatCurrency(balance);
            dom.currentBalance.className = `text-3xl font-bold ${balance < 0 ? 'text-red-600' : 'text-green-600'}`;
        }

        // --- Chart Logic ---
        function initCharts() {
            if (trendChart) trendChart.destroy();
            if (categoryChart) categoryChart.destroy();
            const trendCtx = document.getElementById('trend-chart').getContext('2d');
            trendChart = new Chart(trendCtx, { type: 'line', data: { labels: [], datasets: [{ label: 'Income', data: [], borderColor: '#34d399', backgroundColor: '#34d39920', fill: true, tension: 0.4 }, { label: 'Expense', data: [], borderColor: '#f87171', backgroundColor: '#f8717120', fill: true, tension: 0.4 }] }, options: { responsive: true, scales: { x: { type: 'time', time: { unit: 'day' } }, y: { beginAtZero: true } } } });
            const categoryCtx = document.getElementById('category-chart').getContext('2d');
            categoryChart = new Chart(categoryCtx, { type: 'doughnut', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#4f46e5', '#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ef4444'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } } });
        }

        function updateCharts() {
            const sortedTx = [...transactions].sort((a, b) => new Date(a.date) - new Date(b.date));
            const labels = [...new Set(sortedTx.map(t => t.date))];
            trendChart.data.labels = labels;
            trendChart.data.datasets[0].data = labels.map(d => sortedTx.filter(t => t.type === 'income' && t.date === d).reduce((s, t) => s + parseFloat(t.amount), 0));
            trendChart.data.datasets[1].data = labels.map(d => sortedTx.filter(t => t.type === 'expense' && t.date === d).reduce((s, t) => s + parseFloat(t.amount), 0));
            trendChart.update();

            const expenseByCat = transactions.filter(t => t.type === 'expense').reduce((acc, t) => { acc[t.category] = (acc[t.category] || 0) + parseFloat(t.amount); return acc; }, {});
            categoryChart.data.labels = Object.keys(expenseByCat);
            categoryChart.data.datasets[0].data = Object.values(expenseByCat);
            categoryChart.update();
        }

        // --- Modal & Form Logic ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;

            if (modalId === 'transaction-modal') {
                editingTransactionId = null;
                dom.modalTitle.textContent = 'Add Transaction';
                dom.transactionForm.reset();
                setTransactionType('expense');
                dom.dateInput.valueAsDate = new Date();
            } else if (modalId === 'goal-modal') {
                editingGoalId = null;
                dom.goalModalTitle.textContent = 'Set a New Goal';
                dom.goalForm.reset();
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex', 'active');
        }

        // --- Modal & Form Logic ---
        function openTransactionModalForAdd() {
            editingTransactionId = null;
            dom.modalTitle.textContent = 'Add Transaction';
            dom.transactionForm.reset();
            setTransactionType('expense');
            dom.dateInput.valueAsDate = new Date();
            dom.transactionModal.classList.remove('hidden');
            dom.transactionModal.classList.add('flex', 'active');
        }

        function openTransactionModalForEdit(id) {
            editingTransactionId = id;
            const tx = transactions.find(t => t.id === id);
            if (!tx) return;
            dom.modalTitle.textContent = 'Edit Transaction';
            setTransactionType(tx.type);
            dom.descriptionInput.value = tx.description;
            dom.amountInput.value = tx.amount;
            dom.categorySelect.value = tx.category;
            dom.dateInput.value = tx.date;
            dom.transactionModal.classList.remove('hidden');
            dom.transactionModal.classList.add('flex', 'active');
        }

        function setTransactionType(type) {
            transactionType = type;
            populateCategoryOptions();
            dom.typeIncomeBtn.classList.toggle('bg-green-500', type === 'income');
            dom.typeIncomeBtn.classList.toggle('text-white', type === 'income');
            dom.typeExpenseBtn.classList.toggle('bg-red-500', type === 'expense');
            dom.typeExpenseBtn.classList.toggle('text-white', type === 'expense');
        }

        function populateCategoryOptions() {
            const categories = transactionType === 'income' ? incomeCategories : expenseCategories;
            dom.categorySelect.innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        async function handleTransactionFormSubmit(e) {
            e.preventDefault();
            if (!currentUserId) return;
            const data = { type: transactionType, description: dom.descriptionInput.value, amount: parseFloat(dom.amountInput.value), category: dom.categorySelect.value, date: dom.dateInput.value };
            if (isNaN(data.amount) || data.amount <= 0) { alert("Please enter a valid positive amount."); return; }
            try {
                const collectionRef = collection(db, `users/${currentUserId}/transactions`);
                if (editingTransactionId) await updateDoc(doc(collectionRef, editingTransactionId), data);
                else await addDoc(collectionRef, { ...data, createdAt: serverTimestamp() });
                closeModal();
            } catch (error) { console.error("Error saving transaction:", error); }
        }

        async function deleteTransaction(id) {
            if (!currentUserId || !confirm('Delete this transaction?')) return;
            try { await deleteDoc(doc(db, `users/${currentUserId}/transactions`, id)); } catch (error) { console.error("Error deleting transaction:", error); }
        }

        // --- Goal Logic ---
        function renderGoals() {
            dom.goalsList.innerHTML = '';
            if (goals.length === 0) { dom.goalsEmptyState.classList.remove('hidden'); return; }
            dom.goalsEmptyState.classList.add('hidden');

            goals.forEach(goal => {
                const percentage = Math.min((parseFloat(goal.current) / parseFloat(goal.target)) * 100, 100);
                const item = document.createElement('div');
                item.className = 'border-t pt-4';
                item.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-semibold">${goal.name}</span>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-600">${formatCurrency(goal.current)} / ${formatCurrency(goal.target)}</span>
                            <button class="edit-btn text-gray-400 hover:text-indigo-600" data-id="${goal.id}" data-type="goal"><i class="fas fa-pencil-alt fa-xs"></i></button>
                            <button class="delete-btn text-gray-400 hover:text-red-600" data-id="${goal.id}" data-type="goal"><i class="fas fa-trash-alt fa-xs"></i></button>
                        </div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-indigo-600 h-2.5 rounded-full" style="width: ${percentage}%"></div></div>
                `;
                dom.goalsList.appendChild(item);
            });
            document.querySelectorAll('.delete-btn[data-type="goal"]').forEach(btn => btn.addEventListener('click', (e) => deleteGoal(e.currentTarget.dataset.id)));
            document.querySelectorAll('.edit-btn[data-type="goal"]').forEach(btn => btn.addEventListener('click', (e) => openGoalModalForEdit(e.currentTarget.dataset.id)));
        }

        function openGoalModalForAdd() {
            editingGoalId = null;
            dom.goalModalTitle.textContent = 'Set a New Goal';
            dom.goalForm.reset();
            dom.goalModal.classList.remove('hidden');
            dom.goalModal.classList.add('flex', 'active');
        }

        function openGoalModalForEdit(id) {
            editingGoalId = id;
            const goal = goals.find(g => g.id === id);
            if (!goal) return;
            dom.goalModalTitle.textContent = 'Edit Goal';
            dom.goalNameInput.value = goal.name;
            dom.goalTargetInput.value = goal.target;
            dom.goalCurrentInput.value = goal.current;
            dom.goalModal.classList.remove('hidden');
            dom.goalModal.classList.add('flex', 'active');
        }

        async function handleGoalFormSubmit(e) {
            e.preventDefault();
            if (!currentUserId) return;
            const data = { name: dom.goalNameInput.value, target: parseFloat(dom.goalTargetInput.value), current: parseFloat(dom.goalCurrentInput.value) };
            if (isNaN(data.target) || data.target <= 0 || isNaN(data.current) || data.current < 0) { alert("Please enter valid numbers for target and current amounts."); return; }
            try {
                const collectionRef = collection(db, `users/${currentUserId}/goals`);
                if (editingGoalId) await updateDoc(doc(collectionRef, editingGoalId), data);
                else await addDoc(collectionRef, data);
                closeModal();
            } catch (error) { console.error("Error saving goal:", error); }
        }

        async function deleteGoal(id) {
            if (!currentUserId || !confirm('Delete this goal?')) return;
            try { await deleteDoc(doc(db, `users/${currentUserId}/goals`, id)); } catch (error) { console.error("Error deleting goal:", error); }
        }

        // function closeModal() {
        //     dom.transactionModal.classList.remove('flex', 'active');
        //     dom.transactionModal.classList.add('hidden');
        //     dom.goalModal.classList.remove('flex', 'active');
        //     dom.goalModal.classList.add('hidden');
        // }
        function closeModal() {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.classList.remove('flex', 'active');
                modal.classList.add('hidden');
            });
        }
    </script>
</body>

</html>